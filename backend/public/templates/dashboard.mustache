<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>InstaPay — Seller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand-bg: linear-gradient(90deg, #166534 0%, #22c55e 50%, #34d399 100%);
      --brand-primary: #22c55e;
      --fg: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --bg: #f7fafc;
      --border: #e2e8f0;
    }
    body { margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    header { background: var(--brand-bg); color: #fff; padding: 14px 18px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 12px rgba(0,0,0,.08); }
    header img { height: 22px; display: block; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 20px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); margin-bottom: 16px; }
    .card { background: var(--card); border-radius: 12px; padding: 18px; box-shadow: 0 4px 12px rgba(0,0,0,.06); border: 1px solid var(--border); }
    .title { margin: 16px 0 8px; font-size: 26px; font-weight: 800; }
    .small { font-size: 12px; color: var(--muted); }
    .num { font-size: 28px; font-weight: 700; }
    button { background: var(--brand-primary); color: #fff; border: none; padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    ul { list-style: none; margin: 0; padding: 0; }
    li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: #166534; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.15); font-size: 14px; }
    .toast.error { background: #b91c1c; } /* red for errors */
    svg { width: 100%; height: 220px; }
  </style>
</head>
<body>
  <header>
    <img src="/instapay-logo-text.png" alt="InstaPay" />
  </header>

  <main class="wrap">
    {{#toastMessage}}
    <div class="toast">{{toastMessage}}</div>
    <script>setTimeout(()=>{document.querySelector('.toast')?.remove();}, 4000);</script>
    {{/toastMessage}}
    {{#toastErrorMessage}}
    <div class="toast error">{{toastErrorMessage}}</div>
    <script>setTimeout(()=>{document.querySelector('.toast.error')?.remove();}, 5000);</script>
    {{/toastErrorMessage}}

    <h1 class="title">{{seller.email}}</h1>

    <div class="grid">
      <div class="card">
        <div class="small">Gross Balance</div>
        <div class="num" id="grossBalance">{{balance.grossFormatted}}</div>
        <div class="small">Net After Fees</div>
        <div class="num" id="netBalance">{{balance.netFormatted}}</div>

        <button
          id="payoutBtn"
          data-seller-id="{{seller.sellerId}}"
          style="margin-top:12px"
          {{#balance.disablePayout}}disabled{{/balance.disablePayout}}
        >
          Request Payout
        </button>

        {{#payouts.lastPayoutAt}}
        <div class="small" style="margin-top:8px">Last payout: {{payouts.lastPayoutAt}}</div>
        {{/payouts.lastPayoutAt}}
      </div>

      <div class="card">
        <div class="small">Products</div>
        <div class="num">{{stats.products}}</div>
      </div>

      <div class="card">
        <div class="small">Payment Links</div>
        <div class="num">{{stats.links}}</div>
      </div>

      <div class="card">
        <div class="small">Lifetime Payouts</div>
        <div class="num">{{payouts.lifetimeFormatted}}</div>
      </div>
    </div>

    <div class="card" style="margin-top: 8px;">
      <div style="font-weight:600; margin-bottom: 8px;">Overview (last 30 days)</div>
      <svg viewBox="0 0 {{chart.W}} {{chart.H}}" role="img" aria-label="Metrics over time">
        <rect x="0" y="0" width="{{chart.W}}" height="{{chart.H}}" fill="#ffffff" rx="8" ry="8" />
        {{#chart.yTicks}}
          <line x1="{{../chart.PAD}}" y1="{{y}}" x2="{{x2}}" y2="{{y}}" stroke="#e5e7eb" stroke-width="1" />
          <text x="8" y="{{yText}}" font-size="10" fill="#64748b">{{label}}</text>
        {{/chart.yTicks}}
        {{#chart.xLabels}}
          <text x="{{x}}" y="{{y}}" font-size="10" fill="#64748b" text-anchor="middle">{{label}}</text>
        {{/chart.xLabels}}
        <path d="{{chart.paths.purchases}}" fill="none" stroke="#16a34a" stroke-width="2.5" />
        <path d="{{chart.paths.products}}" fill="none" stroke="#2563eb" stroke-width="2.5" />
        <path d="{{chart.paths.clicks}}" fill="none" stroke="#94a3b8" stroke-width="2.5" />
      </svg>
      <div class="small" style="display:flex;gap:16px;flex-wrap:wrap;margin-top:6px">
        <span><strong>Purchases:</strong> {{totals.purchases}}</span>
        <span><strong>Products Added:</strong> {{totals.products}}</span>
        <span><strong>Buy Clicks:</strong> {{totals.clicks}}</span>
      </div>
    </div>

    <div class="card" style="margin-top: 16px;">
      <div style="font-weight:600; margin-bottom: 8px;">Recent Activity</div>
      {{^recentLedger.length}}
        <div class="small">No recent activity</div>
      {{/recentLedger.length}}
      {{#recentLedger.length}}
      <ul>
        {{#recentLedger}}
          <li>
            <div>
              <div style="font-weight:600; text-transform:capitalize">{{typeDisplay}}</div>
              <div class="small">{{createdAtFormatted}}</div>
              {{#notes}}<div class="small">{{notes}}</div>{{/notes}}
            </div>
            <div style="font-weight:600">{{amountFormatted}}</div>
          </li>
        {{/recentLedger}}
      </ul>
      {{/recentLedger.length}}
    </div>
  </main>

  <script>
  (function () {
    function showToast(message, isError) {
      const t = document.createElement('div');
      t.className = 'toast' + (isError ? ' error' : '');
      t.textContent = message;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), isError ? 6000 : 4000);
    }

    const btn = document.getElementById('payoutBtn');
    if (!btn) return;

    const sellerId = btn.dataset.sellerId;
    if (!sellerId) {
      btn.disabled = true;
      showToast('Missing sellerId (cannot request payout)', true);
      return;
    }

    let inFlight = false;

    async function handlePayout() {
      if (inFlight || btn.disabled) return;
      inFlight = true;
      const originalText = btn.textContent;
      btn.textContent = 'Requesting…';
      btn.disabled = true;

      try {
        const res = await fetch('/api/payouts/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ sellerId })
        });
        let json = {};
        try { json = await res.json(); } catch (_) {}

        if (!res.ok) {
          throw new Error(json.error || 'Payout failed');
        }

        showToast('Payout request submitted.');
        // Zero out balances (instant UI feedback)
        const grossEl = document.getElementById('grossBalance');
        const netEl = document.getElementById('netBalance');
        if (grossEl) grossEl.textContent = '$0.00';
        if (netEl) netEl.textContent = '$0.00';
      } catch (e) {
        showToast(e.message || 'Payout failed', true);
        btn.disabled = false; // allow retry
        btn.textContent = originalText;
      } finally {
        inFlight = false;
      }
    }

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      handlePayout();
    });
  })();
  </script>
</body>
</html>