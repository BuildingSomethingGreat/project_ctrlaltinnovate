{
    "openapi": "3.1.1",
    "info": {
      "title": "Quick-Pay Concierge API",
      "version": "1.2.1",
      "description": "API for seller onboarding, product/link creation, Stripe Checkout, metrics, image upload, digital downloads, server-rendered payment pages, and test seeders."
    },
    "servers": [
      {
        "url": "https://ctrlaltinnovate-64f4a6aee6b6.herokuapp.com"
      }
    ],
    "components": {
      "schemas": {
        "CheckoutSchema": {
          "type": "object",
          "properties": {
            "theme": {
              "type": "string",
              "description": "Theme name",
              "example": "default"
            },
            "backgroundColor": {
              "type": "string",
              "description": "Hex color",
              "example": "#f7fafc"
            },
            "accentColor": {
              "type": "string",
              "description": "Hex color",
              "example": "#2563eb"
            },
            "buttonColor": {
              "type": "string",
              "description": "Hex color",
              "example": "#2563eb"
            },
            "textColor": {
              "type": "string",
              "description": "Hex color",
              "example": "#0f172a"
            }
          },
          "additionalProperties": true
        },
        "DigitalDownload": {
          "type": "object",
          "properties": {
            "fileName": {
              "type": "string"
            },
            "contentType": {
              "type": "string"
            },
            "storagePath": {
              "type": "string",
              "description": "GCS path where file is stored"
            },
            "fileSize": {
              "type": "integer",
              "nullable": true,
              "description": "Size in bytes (if known)"
            },
            "updatedAt": {
              "type": "string",
              "format": "date-time"
            }
          }
        },
        "Seller": {
          "type": "object",
          "properties": {
            "sellerId": {
              "type": "string"
            },
            "email": {
              "type": "string",
              "format": "email"
            },
            "stripeAccountId": {
              "type": "string"
            },
            "stripeAccountStatus": {
              "type": "object"
            },
            "businessProfile": {
              "type": "object",
              "nullable": true
            },
            "country": {
              "type": "string",
              "nullable": true
            },
            "active": {
              "type": "boolean",
              "nullable": true
            },
            "createdAt": {
              "type": "string",
              "format": "date-time"
            }
          }
        },
        "Product": {
          "type": "object",
          "properties": {
            "productId": {
              "type": "string"
            },
            "sellerId": {
              "type": "string"
            },
            "title": {
              "type": "string"
            },
            "description": {
              "type": "string"
            },
            "price_cents": {
              "type": "integer"
            },
            "currency": {
              "type": "string"
            },
            "image_url": {
              "type": "string",
              "format": "uri",
              "nullable": true
            },
            "inventory": {
              "type": "integer",
              "nullable": true
            },
            "active": {
              "type": "boolean"
            },
            "isSold": {
              "type": "boolean",
              "nullable": true,
              "description": "Set to true on successful checkout via webhook"
            },
            "checkoutSchema": {
              "$ref": "#/components/schemas/CheckoutSchema"
            },
            "digitalDownload": {
              "$ref": "#/components/schemas/DigitalDownload"
            },
            "createdAt": {
              "type": "string",
              "format": "date-time"
            }
          }
        },
        "Link": {
          "type": "object",
          "properties": {
            "linkId": {
              "type": "string"
            },
            "productId": {
              "type": "string"
            },
            "sellerId": {
              "type": "string"
            },
            "createdAt": {
              "type": "string",
              "format": "date-time"
            },
            "expiresAt": {
              "type": "string",
              "format": "date-time",
              "nullable": true
            },
            "active": {
              "type": "boolean",
              "nullable": true
            },
            "hasDigital": {
              "type": "boolean",
              "description": "Indicates if a digital download will be delivered after purchase"
            },
            "digitalDownload": {
              "allOf": [
                {
                  "$ref": "#/components/schemas/DigitalDownload"
                }
              ],
              "description": "Snapshot from product (if any), for convenience",
              "nullable": true
            }
          }
        },
        "Order": {
          "type": "object",
          "properties": {
            "orderId": {
              "type": "string"
            },
            "checkoutSessionId": {
              "type": "string"
            },
            "linkId": {
              "type": "string",
              "nullable": true
            },
            "productId": {
              "type": "string",
              "nullable": true
            },
            "sellerId": {
              "type": "string",
              "nullable": true
            },
            "amount_total": {
              "type": "integer",
              "nullable": true
            },
            "currency": {
              "type": "string",
              "nullable": true
            },
            "buyer_email": {
              "type": "string",
              "format": "email",
              "nullable": true
            },
            "shipping": {
              "type": "object",
              "nullable": true
            },
            "status": {
              "type": "string"
            },
            "createdAt": {
              "type": "string",
              "format": "date-time"
            }
          }
        },
        "SellerMetrics": {
          "type": "object",
          "properties": {
            "stripe": {
              "type": "object",
              "properties": {
                "balance": {
                  "type": "object"
                },
                "recentPaymentIntents": {
                  "type": "array",
                  "items": {
                    "type": "object"
                  }
                }
              }
            },
            "orders": {
              "type": "array",
              "items": {
                "$ref": "#/components/schemas/Order"
              }
            },
            "salesByProduct": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "count": {
                    "type": "integer"
                  },
                  "revenue_cents": {
                    "type": "integer"
                  }
                }
              }
            }
          }
        },
        "UploadResponse": {
          "type": "object",
          "properties": {
            "imageUrl": {
              "type": "string",
              "format": "uri"
            }
          }
        },
        "CreateCheckoutSessionResponse": {
          "type": "object",
          "properties": {
            "url": {
              "type": "string",
              "format": "uri"
            }
          }
        },
        "Error": {
          "type": "object",
          "properties": {
            "error": {
              "type": "string"
            }
          }
        }
      }
    },
    "paths": {
      "/api/upload": {
        "post": {
          "operationId": "uploadImage",
          "summary": "Upload an image to Firebase Storage and get a public URL",
          "requestBody": {
            "required": true,
            "content": {
              "image/*": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Upload successful",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/UploadResponse"
                  }
                }
              }
            },
            "400": {
              "description": "No file or invalid content type",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "500": {
              "description": "Upload failed",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/sellers/onboard": {
        "post": {
          "operationId": "onboardSeller",
          "summary": "Create Stripe Express connected account and onboarding link (Firebase protected)",
          "security": [
            {
              "BearerAuth": []
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "email"
                  ],
                  "properties": {
                    "sellerId": {
                      "type": "string",
                      "description": "Optional; server will generate if absent"
                    },
                    "email": {
                      "type": "string",
                      "format": "email"
                    },
                    "business_type": {
                      "type": "string",
                      "enum": [
                        "individual",
                        "company"
                      ],
                      "nullable": true
                    },
                    "country": {
                      "type": "string",
                      "default": "US"
                    },
                    "business_profile": {
                      "type": "object",
                      "nullable": true
                    }
                  }
                },
                "example": {
                  "email": "seller@example.com",
                  "business_type": "individual",
                  "country": "US"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Onboarding link created (welcome email is also sent)",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "sellerId": {
                        "type": "string"
                      },
                      "stripeAccountId": {
                        "type": "string"
                      },
                      "accountLink": {
                        "type": "string",
                        "format": "uri"
                      }
                    }
                  }
                }
              }
            },
            "4XX": {
              "description": "Client error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/products": {
        "post": {
          "operationId": "createProduct",
          "summary": "Create product",
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": [
                    "sellerId",
                    "title",
                    "price_cents"
                  ],
                  "properties": {
                    "sellerId": {
                      "type": "string"
                    },
                    "title": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    },
                    "price_cents": {
                      "type": "integer",
                      "description": "Amount in cents"
                    },
                    "currency": {
                      "type": "string",
                      "default": "usd"
                    },
                    "image_url": {
                      "type": "string",
                      "format": "uri",
                      "nullable": true
                    },
                    "inventory": {
                      "type": "integer",
                      "nullable": true
                    },
                    "checkoutSchema": {
                      "$ref": "#/components/schemas/CheckoutSchema"
                    }
                  }
                },
                "example": {
                  "sellerId": "SELLER_123",
                  "title": "Fall Retreat Hoodie",
                  "description": "Midweight fleece, sizes S–XXL",
                  "price_cents": 3799,
                  "currency": "usd",
                  "image_url": "https://cdn.yourapp.com/img/hoodie.png",
                  "inventory": 25,
                  "checkoutSchema": {
                    "theme": "default",
                    "backgroundColor": "#f7fafc",
                    "accentColor": "#2563eb",
                    "buttonColor": "#2563eb",
                    "textColor": "#0f172a"
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Created product",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "product": {
                        "$ref": "#/components/schemas/Product"
                      }
                    }
                  }
                }
              }
            },
            "4XX": {
              "description": "Client error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/products/{productId}/associate": {
        "post": {
          "operationId": "associateProductToSeller",
          "summary": "Associate product to seller (Firebase protected)",
          "security": [
            {
              "BearerAuth": []
            }
          ],
          "parameters": [
            {
              "name": "productId",
              "in": "path",
              "required": true,
              "schema": {
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "sellerId"
                  ],
                  "properties": {
                    "sellerId": {
                      "type": "string"
                    }
                  }
                },
                "example": {
                  "sellerId": "SELLER_123"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Association updated",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "success": {
                        "type": "boolean"
                      }
                    }
                  }
                }
              }
            },
            "404": {
              "description": "Product not found",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/products/{productId}/digital": {
        "post": {
          "operationId": "uploadDigitalForProduct",
          "summary": "Upload a digital file for a product (stored privately; used for auto-fulfillment)",
          "description": "Server expects raw binary via application/octet-stream. Optional header 'x-filename' may be sent by clients and will be sanitized server-side. For tool compatibility, multipart and base64 JSON fallbacks are also defined.",
          "parameters": [
            {
              "name": "productId",
              "in": "path",
              "required": true,
              "schema": {
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "required": true,
            "content": {
              "application/octet-stream": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              },
              "multipart/form-data": {
                "schema": {
                  "type": "object",
                  "required": [
                    "file"
                  ],
                  "properties": {
                    "file": {
                      "type": "string",
                      "format": "binary"
                    },
                    "filename": {
                      "type": "string",
                      "description": "Optional: original file name"
                    },
                    "contentType": {
                      "type": "string",
                      "description": "Optional MIME type"
                    }
                  }
                }
              },
              "application/json": {
                "schema": {
                  "type": "object",
                  "description": "Explorer-friendly fallback; server still stores the decoded bytes.",
                  "required": [
                    "fileBase64"
                  ],
                  "properties": {
                    "fileBase64": {
                      "type": "string",
                      "format": "byte",
                      "description": "Base64 file content"
                    },
                    "filename": {
                      "type": "string"
                    },
                    "contentType": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Digital file saved and product updated",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "digitalDownload": {
                        "$ref": "#/components/schemas/DigitalDownload"
                      }
                    }
                  }
                }
              }
            },
            "400": {
              "description": "Missing productId or file",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "404": {
              "description": "Product not found",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "500": {
              "description": "Failed to upload digital file",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/links": {
        "post": {
          "operationId": "createLink",
          "summary": "Create a short link for a product (returns landing page URL and digital flag)",
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "productId",
                    "sellerId"
                  ],
                  "properties": {
                    "productId": {
                      "type": "string"
                    },
                    "sellerId": {
                      "type": "string"
                    },
                    "expiresAt": {
                      "type": "string",
                      "format": "date-time",
                      "nullable": true
                    }
                  }
                },
                "example": {
                  "productId": "prod_abc123",
                  "sellerId": "SELLER_123"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Link created",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "linkId": {
                        "type": "string"
                      },
                      "pageUrl": {
                        "type": "string",
                        "format": "uri"
                      },
                      "hasDigital": {
                        "type": "boolean"
                      }
                    }
                  },
                  "examples": {
                    "example": {
                      "value": {
                        "linkId": "K3P9JQW",
                        "pageUrl": "https://pay.yourapp.com/p/K3P9JQW?digital=1",
                        "hasDigital": true
                      }
                    }
                  }
                }
              }
            },
            "4XX": {
              "description": "Client error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/p/{linkId}": {
        "get": {
          "operationId": "renderPaymentPage",
          "summary": "Server-rendered payment page (HTML)",
          "parameters": [
            {
              "name": "linkId",
              "in": "path",
              "required": true,
              "schema": {
                "type": "string"
              }
            },
            {
              "name": "digital",
              "in": "query",
              "required": false,
              "schema": {
                "type": "string",
                "enum": [
                  "0",
                  "1",
                  "true",
                  "false"
                ]
              },
              "description": "Optional override to force digital flag (e.g., ?digital=1)"
            }
          ],
          "responses": {
            "200": {
              "description": "HTML payment page",
              "content": {
                "text/html": {
                  "schema": {
                    "type": "string"
                  }
                }
              }
            },
            "404": {
              "description": "Link or product not found"
            },
            "500": {
              "description": "Server error"
            }
          }
        }
      },
      "/api/create-checkout-session": {
        "post": {
          "operationId": "createCheckoutSession",
          "summary": "Create Stripe Checkout Session for a link",
          "description": "Builds success_url internally (adds &digital=1 when applicable). Populates metadata with linkId/productId/sellerId/hasDigital. Returns the hosted Checkout URL.",
          "requestBody": {
            "required": true,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "linkId"
                  ],
                  "properties": {
                    "linkId": {
                      "type": "string"
                    }
                  }
                },
                "example": {
                  "linkId": "K3P9JQW"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Checkout session created",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/CreateCheckoutSessionResponse"
                  }
                }
              }
            },
            "4XX": {
              "description": "Client error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/sellers/{sellerId}/metrics": {
        "get": {
          "operationId": "getSellerMetrics",
          "summary": "Seller metrics (Stripe balance, recent intents, orders aggregation) (Firebase protected)",
          "security": [
            {
              "BearerAuth": []
            }
          ],
          "parameters": [
            {
              "name": "sellerId",
              "in": "path",
              "required": true,
              "schema": {
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Metrics payload",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/SellerMetrics"
                  }
                }
              }
            },
            "4XX": {
              "description": "Client error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/products/{productId}": {
        "get": {
          "operationId": "getProduct",
          "summary": "Get product by id",
          "parameters": [
            {
              "name": "productId",
              "in": "path",
              "required": true,
              "schema": {
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Product",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "product": {
                        "$ref": "#/components/schemas/Product"
                      }
                    }
                  }
                }
              }
            },
            "404": {
              "description": "Not found",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/sellers/{sellerId}": {
        "get": {
          "operationId": "getSeller",
          "summary": "Get seller by id",
          "parameters": [
            {
              "name": "sellerId",
              "in": "path",
              "required": true,
              "schema": {
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Seller",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "seller": {
                        "$ref": "#/components/schemas/Seller"
                      }
                    }
                  }
                }
              }
            },
            "404": {
              "description": "Not found",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/seed/product": {
        "post": {
          "operationId": "seedProduct",
          "summary": "Seed a random product (testing)",
          "requestBody": {
            "required": false,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "sellerId": {
                      "type": "string"
                    }
                  }
                },
                "example": {
                  "sellerId": "SELLER_123"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Seeded product",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "product": {
                        "$ref": "#/components/schemas/Product"
                      }
                    }
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/seed/link": {
        "post": {
          "operationId": "seedLink",
          "summary": "Seed a random link (testing)",
          "requestBody": {
            "required": false,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "productId": {
                      "type": "string"
                    }
                  }
                },
                "example": {
                  "productId": "prod_abc123"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Seeded link",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "link": {
                        "$ref": "#/components/schemas/Link"
                      },
                      "pageUrl": {
                        "type": "string",
                        "format": "uri"
                      }
                    }
                  }
                }
              }
            },
            "404": {
              "description": "No products found or product not found",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      },
      "/api/seed/seller": {
        "post": {
          "operationId": "seedSeller",
          "summary": "Seed a random seller (testing)",
          "requestBody": {
            "required": false,
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "email": {
                      "type": "string",
                      "format": "email"
                    }
                  }
                },
                "example": {
                  "email": "seeded@example.com"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Seeded seller + onboarding link",
              "content": {
                "application/json": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "seller": {
                        "$ref": "#/components/schemas/Seller"
                      },
                      "stripeAccountId": {
                        "type": "string"
                      },
                      "accountLink": {
                        "type": "string",
                        "format": "uri"
                      }
                    }
                  }
                }
              }
            },
            "5XX": {
              "description": "Server error",
              "content": {
                "application/json": {
                  "schema": {
                    "$ref": "#/components/schemas/Error"
                  }
                }
              }
            }
          }
        }
      }
    }
  }